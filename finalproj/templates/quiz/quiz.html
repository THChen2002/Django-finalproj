{% extends "base.html" %}
{% block title %}氣象科普測驗{% endblock %}
{% block content %}
{% load static %}
{% load quiz_filter %}
<link rel="stylesheet" href="{% static 'css/quiz.css' %}" type="text/css">
<div class="container" style="justify-content: center;">
   <br>
   <div class="row">
      <div class="col-md-6">
         <h1>氣象科普測驗</h1>
      </div>
      <div class="col-md-6">
         <button type="button" class="btn btn-danger"  data-bs-toggle="modal"data-bs-target="#alert" style="float: right; margin-left: 20px;">回測驗首頁</button>
      </div>
   </div>
   <form id="quizForm" action="/quiz/result/" method="post">
      {% csrf_token %}
      <!-- 這裡是為了讓後端知道是哪一個測驗 -->
      <input type="hidden"  name="quiz_id" value='{{ quiz_id }}'>
      <!-- 這裡是為了讓後端知道花了多少時間 -->
      <input type="hidden" id="timeInput" name="time" value="0">
      <div id="timer">00:00</div>
      {% for question in questions %}
      <div class="mainquiz container-fluid">
         <div class="scp-quizzes-main">
            <div class="scp-quizzes-data">
               <div class="row">
                  <div>
                     <h3>{{ question.question }}</h3>
                     <h4>難易度：
                        {% for i in question.question_level|times %}
                        <img src="{% static 'images/quiz/star.png' %}" width="30px" height="30px">
                        {% endfor %}
                     </h4>

                     {% if question.question_url%}
                     <img src="{{ question.question_url }}" alt="" width="30%">
                     {% endif %}
                  </div>
               </div>
               <br>
               <input type="radio" name="question{{ forloop.counter }}" value="{{ question.choice1 }}">
               <label id="label1_{{ forloop.counter }}" onclick="recordAnswer({{ forloop.counter }}, this, 'A')">1. {{ question.choice1 }}</label>
               <br>
               <input type="radio" name="question{{ forloop.counter }}" value="{{ question.choice2 }}">
               <label id="label2_{{ forloop.counter }}" onclick="recordAnswer({{ forloop.counter }}, this, 'B')">2. {{ question.choice2 }}</label>
               <br>
               <input type="radio" name="question{{ forloop.counter }}" value="{{ question.choice3 }}">
               <label id="label3_{{ forloop.counter }}" onclick="recordAnswer({{ forloop.counter }}, this, 'C')">3. {{ question.choice3 }}</label>
               <br>
               <input type="radio" name="question{{ forloop.counter }}" value="{{ question.choice4 }}">
               <label id="label4_{{ forloop.counter }}" onclick="recordAnswer({{ forloop.counter }}, this, 'D')">4. {{ question.choice4 }}</label>
               <input type="hidden" id="hiddenInput{{ forloop.counter }}" name="question{{ forloop.counter }}" value='{"id": {{ question.pk }}, "userAnswer": "0"}'>
            </div>
         </div>
      </div>
      {% endfor %}
      <button type="submit">提交</button>
   </form>



   <!--警告頁面-->
   <div class="modal fade" id="alert" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <h5 class="modal-title" id="staticBackdropLabel">提醒</h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
               你確定要離開嗎?測驗內容將不會被儲存!
            </div>
            <div class="modal-footer">
               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
               <a href="/quiz/index" type="button" class="btn btn-danger">回測驗首頁</a>
            </div>
         </div>
      </div>
   </div>
</div>
<br>
<br>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js" type='text/javascript'></script>
<script>
   // 定義一個空物件來儲存使用者的選項
   var answers = {};

   // 當使用者選擇一個選項時，將選項存入answers變數中
   function recordAnswer(questionNum, selectedOption, userAnswer) {
      // 將之前選中的標籤顏色重置
      var prevSelectedOptions = document.querySelectorAll("[id$='_" + questionNum + "']");
      console.log("prev",prevSelectedOptions);
      if (prevSelectedOptions) {
         for (var i = 0; i < prevSelectedOptions.length; i++) {
            var prevSelectedOption = prevSelectedOptions[i];

            // 将之前选中的标签颜色重置
            prevSelectedOption.style.backgroundColor = "";
         }
      }
      // 更新答案及相關標籤的顏色和選中狀態
      answers[questionNum] = userAnswer;
      var hiddenInput = document.getElementById("hiddenInput" + questionNum);
      var hiddenValue = hiddenInput.value;
      var hiddenValueObject = JSON.parse(hiddenValue);
      hiddenValueObject.userAnswer = userAnswer;
      hiddenInput.value = JSON.stringify(hiddenValueObject);
      var labelId = selectedOption.id;
      console.log(labelId);
      document.getElementById(labelId).style.backgroundColor = "#78C1EA";
      
      console.log(answers);
   }
</script>
<script>
   // 計時器變數
   var timerInterval;
   var seconds = 0, minutes = 0
   var timerDisplay = document.getElementById('timer');
   var timeInput = document.getElementById('timeInput');

   // 啟動計時器
   function startTimer() {
      timerInterval = setInterval(updateTimer, 1000);
   }
 
   // 更新計時器顯示
   function updateTimer() {
      seconds++;
      if (seconds >= 60) {
         seconds = 0;
         minutes++;
         if (minutes >= 60) {
            alert('時間到!');
         }
      }
 
      // 格式化時間
      var timeString = formatTime(minutes) + ":" + formatTime(seconds);

      // 更新計時器顯示
      timerDisplay.textContent = timeString;
      // 將時間值設定為隱藏input元素的值
      timeInput.value = minutes*60 + seconds;
   }
 
   // 格式化時間
   function formatTime(time) {
      return time < 10 ? "0" + time : time;
   }
   // 提交表單時停止計時器
   document.getElementById('quizForm').addEventListener('submit', function() {
      clearInterval(timerInterval);
   });

 
   // 開始計時器
   startTimer();
 </script>
{% endblock %}